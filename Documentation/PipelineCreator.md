# Pipeline Creator

Pipeline Creator is a tool that enables you to assemble a pipeline from existing Slicer modules and save it as a new module. The new module can be used by itself, as a step in a larger pipeline or inside of Pipeline Case Iterator for batch processing.

In this document we will use the following terms to refer to the different components of a pipeline:

- *Pipeline*: Any piece of code that is marked up with the `@slicerPipeline` decorator. This can be standalone pieces of code or part of a Pipeline Module. As these are just regular functions we will also talk about their input parameters or inputs, and their return values or outputs.
- *Pipeline Module*: A slicer module that also presents it's functionality as a pipeline, the product of Pipeline Creator are Pipeline Modules
- *Pipeline Step*: or just step is a pipeline used as inside of Pipeline Creator.

## Quick Start

1. To add steps to your pipeline, press the **Add Step** button in the `Pipeline Creator`. This will show a window where you can select the item you want to add.
2. **Pick the item** you want, it will be added as a step to your pipeline.
3. For each parameter you decide wether you want its value to be fixed

 to a given value, refer to an output of a previous step, or be set by the user at runtime. You can add parameters to be set by the user by pressing the **+** button in `Step 0 - Inputs`.
3. You need to **repeat** this process until the pipeline has all the steps in your workflow.
4. Once all the steps have been appropriately captured in your pipeline interface, you can **fill in the remaining fields** like name and output directory.
5. Press **Test Pipeline** to make sure the pipeline is valid.
6. Press **Generate Pipeline** and the pipeline will be created.

## The Pipeline Creator module

In the Pipeline Creator you assemble previously created pipelines into a new Pipeline Module. The Pipeline Creator module is found in the Modules menu under the Pipelines category.

When you start up the Pipeline Creator with an empty pipeline you will see the following UI elements:

### Main Section

TBD

### Input and Output steps

- Step 0 Inputs: This is where the _overall_ inputs to your newly created pipeline will be defined. These inputs will be available to all the steps in your pipeline. The inputs may go to any of the steps. After the pipeline module has been generated all of the inputs will be available for you to set when you run the pipeline.

- Step 1 Outputs: This is where you will define the _overall_ outputs of your newly created pipeline. The outputs may come from any of the steps. This step will be renumbered as you add more steps to your pipeline.

In both the Input and Output steps you can add new parameters by pressing the "+" button. Parameters can be renamed just by entering a new name in the text box. They can be deleted by clicking on the trash icon.

### Pipeline steps

- Add Step: This button will open a popup window where you can select the step you want to add to your pipeline. The steps are organized in categories. Each additional step will be places _after_ the last step and before the Outputs step. You can reorder the steps by using the up and down arrows. You can delete a step by clicking on the trash icon.

The interface for a step will show which input parameters (Inputs) this step takes, and what the return value of the step is. The return value (Outputs) will be available as an input to the other steps in the pipeline. The user interface for the step is automatically generated by inspecting the function signature of the step.

The value of parameter inside a step can either be _fixed_ or a _reference_ to another parameter. By default all parameters except for those that are slicer nodes are fixed and you can edit the value directly in the Pipeline Creator. If you want to reference another parameter you can uncheck the _Fixed_ checkbox.  After that you can select the parameter you want to reference in the combo box. When running the value of the parameter will be the value of the referenced parameter.

You will only be able to connect parameters to other parameters whose type matches. For example you can only connect a `vtkMRMLScalarVolumeNode` to a `vtkMRMLScalarVolumeNode` or a `float` to a `float`. You can also only connect parameters that are _upstream_ of the parameter you are connecting to. For example you can connect a parameter in step 2 to a parameter in step 1, but not the other way around. The popup window will only show you the parameters that are available to connect to.

While all intermediate pipeline parameters have a fixed type input parameters won't have a type until they are connected to another parameters in the pipeline.

### Testing and Creating

To test or actually create your pipeline every parameter that is not fixed needs to be connected to another parameter. You can test your pipeline by pressing the _Test Pipeline_ button. This will generate the code in a temporary file and run it. If there are any errors in the pipeline you will see them in the Python console and in a error dialog. If the pipeline was successfully generated you will see its interface in place of the Pipeline Creator interface. You can use the "Back" button to go back to the Pipeline Creator interface.

When you are happy with your pipeline use the _Generate Pipeline_ button to create a new pipeline module. This will create a new loadable python module in the directory that you specified. The generated pipeline is a regular slicer module and can be used as such. You can also use it as a step in another pipeline. The code generated is regular python and can be edited as such.

## Creating a pipeline in source

To add a pipeline to your extension or wrap specific slicer functionality in a pipeline you can use the `@slicerPipeline` decorator. This decorator registers the function as a pipeline, after that it can be used in the Pipeline Creator.

The `@slicerPipeline` decorator looks like this `@slicerPipeline(name=None, dependencies=None, categories=None)` with `name` being the name of the pipeline that you are trying to register. `dependencies` being a list of other modules that this pipeline depends on and `categories` being a list of categories that this pipeline belongs to. If `dependencies` does not contain all the modules that are needed by the code that you are writing the code generated that uses this pipeline may not run correctly as the appropriate `import` statement will not be generated. The `PipelineModules` directory in the SlicerPipelines modules contains a number of examples of pipelines that are registered in source.

For example:

```python
@slicerPipeline(name="Export Segmentation to LabelMap", categories=["Conversions", "Segmentation Operations"])
    def exportSegmentationToLabelMap(segmentation: vtkMRMLSegmentationNode) -> vtkMRMLLabelMapVolumeNode:
    outputNode = slicer.mrmlScene.AddNewNodeByClass('vtkMRMLLabelMapVolumeNode')
    slicer.modules.segmentations.logic().ExportAllSegmentsToLabelmapNode(
        segmentation,
        outputNode,
        slicer.vtkSegmentation.EXTENT_REFERENCE_GEOMETRY)
return outputNode
```

Slicer pipelines uses the python [type system](https://docs.python.org/3/library/typing.html) extensively you do need to annotate the input parameters as well as the return type of the function. The type annotations are used to generate the user interface and to correctly connect the parameters in the pipeline.

Additionally you can use functionality from [ParameterNodeWrapper](https://github.com/Slicer/Slicer/tree/main/Base/Python/slicer/parameterNodeWrapper) library inside of slicer to augment the UI that will be created for your pipeline.

```python
@slicerPipeline(name="SurfaceToolbox.ScaleMesh", dependencies=_surfaceToolboxDeps, categories=_surfaceToolboxCats)
def scaleMesh(mesh: vtkMRMLModelNode,
              scaleX: Annotated[float, Minimum(0)],
              scaleY: Annotated[float, Minimum(0)],
              scaleZ: Annotated[float, Minimum(0)]) -> vtkMRMLModelNode:

    return _surfaceToolboxRun(mesh, "scale", {
        "scaleX": str(scaleX),
        "scaleY": str(scaleY),
        "scaleZ": str(scaleZ),
    })
```

In this case the UI will not accept values less than 0 for the scale parameters. These can be found in [validators.py](https://github.com/Slicer/Slicer/blob/main/Base/Python/slicer/parameterNodeWrapper/validators.py)

